# 03.æ•´åˆåœºæ™¯

## 1.å‰æœŸå‡†å¤‡

### 1.1.æ‰¹é‡å®‰è£…è½¯ä»¶

åœ¨dockerä¸­å®‰è£…`redis`ã€`prometheus`ã€`kafka`ã€`grafana`ã€`mysql`

`docker-compose.yml`

```yml
version: '3.9'

services:
  redis:
    image: redis:latest
    container_name: redis
    restart: always
    ports:
      - "6379:6379"
    networks:
      - backend

  zookeeper:
    image: bitnami/zookeeper:latest
    container_name: zookeeper
    restart: always
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
      ALLOW_ANONYMOUS_LOGIN: yes
    networks:
      - backend

  kafka:
    image: bitnami/kafka:3.4.0
    container_name: kafka
    restart: always
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
    environment:
      ALLOW_PLAINTEXT_LISTENER: yes
      KAFKA_CFG_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    networks:
      - backend
  
  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name:  kafka-ui
    restart: always
    depends_on:
      - kafka
    ports:
      - "8080:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: dev
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:9092
    networks:
      - backend

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    restart: always
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"
    networks:
      - backend

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: always
    depends_on:
      - prometheus
    ports:
      - "3000:3000"
    networks:
      - backend

networks:
  backend:
    name: backend
```

`prometheus.yml`

```yaml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']

  - job_name: 'redis'
    static_configs:
      - targets: ['redis:6379']

  - job_name: 'kafka'
    static_configs:
      - targets: ['kafka:9092']
```

### 1.2.è®¿é—®æµ‹è¯•

#### WEB-UI

[kafka-ui](http://localhost:8080/)

[Grafana](http://localhost:3000/login)

[Prometheus](http://localhost:9090/)

#### GUI

[rediså®¢æˆ·ç«¯](https://github.com/RedisInsight/RedisInsight)

## 2.æ•´åˆ

### 2.1.NoSQL

> æ•´åˆredis

### 2.2.æ¥å£æ–‡æ¡£

> sawgger

### 2.3.è¿œç¨‹è°ƒç”¨

RPCï¼ˆRemote Procedure Callï¼‰ï¼šè¿œç¨‹è¿‡ç¨‹è°ƒç”¨

```mermaid
flowchart TB
A[AæœåŠ¡ç”¨æˆ·æœåŠ¡]
B[BæœåŠ¡è®¢å•åŠ¡]
C[CæœåŠ¡å¤©æ°”æŸ¥è¯¢]

A --"httpclientã€openfeignã€dubbo..."--> B
A --"httpclient..."--> C
```

æœ¬åœ°è¿‡ç¨‹è°ƒç”¨ï¼š`a();b();a(){ b(); }; ` ä¸åŒæ–¹æ³•éƒ½åœ¨ä¸€ä¸ªJVMè¿è¡Œ

è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼š

- æœåŠ¡æä¾›è€…
- æœåŠ¡æ¶ˆè´¹è€…
- é€šè¿‡è¿æ¥å¯¹æ–¹æœåŠ¡å™¨è¿›è¡Œè¯·æ±‚/å“åº”äº¤äº’ï¼Œæ¥å®ç°è°ƒç”¨æ•ˆæœ



> å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦è°ƒç”¨åˆ«äººçš„åŠŸèƒ½
>
> - å¦‚æœäº‹å†…éƒ¨å¾®æœåŠ¡ï¼Œå¯ä»¥é€šè¿‡cloudã€æ³¨å†Œä¸­å…´ã€openfeignç­‰è¿›è¡Œè°ƒç”¨
> - å¦‚æœæ˜¯å¤–éƒ¨æš´éœ²çš„ï¼Œå¯ä»¥å‘é€httpè¯·æ±‚ã€æˆ–éµå¾ªå¤–éƒ¨åè®®è¿›è¡Œè°ƒç”¨
>
> SpringBootæ•´åˆæä¾›äº†å¾ˆå¤šæ–¹å¼è¿›è¡Œè¿œç¨‹è°ƒç”¨
>
> - è½»é‡çº§å®¢æˆ·ç«¯æ–¹å¼
>   - RestTemplateï¼šæ™®é€šå¼€å‘
>   - WebClientï¼šå“åº”å¼ç¼–ç¨‹å¼€å‘ `http-client`
>   - Http Interfaceï¼šå£°æ˜å¼ç¼–ç¨‹ `spring-boot-starter-webflux-3.1.0`
>
> - Spring Cloudåˆ†å¸ƒå¼è§£å†³æ–¹æ¡ˆ
>   - Spring Cloud OpenFeign
> - ç¬¬ä¸‰æ–¹æ¡†æ¶
>   - Dubbo
>   - gRPC
>   - ...

API/SDKçš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ

- apiï¼šæ¥å£ï¼ˆApplication Progranmming Interfaceï¼‰
  - è¿œç¨‹æä¾›åŠŸèƒ½
- sdkï¼šå·¥å…·åŒ…ï¼ˆSoftware Development Kitï¼‰
  - å¯¼å…¥jaråŒ…ï¼Œç›´æ¥è°ƒç”¨åŠŸèƒ½å³å¯

### 2.4.æ¶ˆæ¯æœåŠ¡

#### æ¶ˆæ¯é˜Ÿåˆ—-åœºæ™¯

##### 1.å¼‚æ­¥

###### åœºæ™¯1

```mermaid
flowchart LR
A(("ğŸ˜€"))
A1[æ³¨å†Œä¿¡æ¯]
A2[å‘é€çŸ­ä¿¡]
A3[å‘é€é‚®ä»¶]

A --æ³¨å†Œ--> A1 --> A2 --> A3

B(("ğŸ˜€"))
B1[æ³¨å†Œä¿¡æ¯]
B2[å‘é€çŸ­ä¿¡]
B3[å‘é€é‚®ä»¶]

B --æ³¨å†Œ--> B1 --> B2
B1  --> B3


C(("ğŸ˜€")) --æ³¨å†Œ--> 
C1[æ³¨å†Œä¿¡æ¯] --> 
C2[å‘é€çŸ­ä¿¡] --> 
C3[å‘é€é‚®ä»¶]
```



##### 2.è§£è€¦

###### åœºæ™¯2

```mermaid
flowchart
A[è®¢å•ç³»ç»Ÿ] --è°ƒç”¨åº“å­˜æ¥å£-->  B[åº“å­˜ç³»ç»Ÿ]

C[è®¢å•ç³»ç»Ÿ] --å‘é€æ¶ˆæ¯--> D[æ¶ˆæ¯é˜Ÿåˆ—] 
E[åº“å­˜ç³»ç»Ÿ] --ç›‘å¬æ¶ˆæ¯--> D
```

##### 3.å‰Šå³°

###### åœºæ™¯3

```mermaid
flowchart
A[ç”¨æˆ·è¯·æ±‚] --å†™å…¥--> B[æ¶ˆæ¯é˜Ÿåˆ—]
C[ä¸šåŠ¡å¤„ç†] --æŒ‰ç…§ä¸šåŠ¡èƒ½åŠ›å¤„ç†--> B
```



##### 4.ç¼“å†²

###### åœºæ™¯4

```mermaid
flowchart
A[æ—¥å¿—é‡‡é›†å®¢æˆ·ç«¯]
app --> A
ä¸»æœº --> A
å®¹å™¨ --> A
lot --> A
... --> A
A --å†™å…¥--> æ¶ˆæ¯é˜Ÿåˆ—
æ—¥å¿—åˆ†æå¤„ç† --è®¢é˜…æ¶ˆè´¹--> æ¶ˆæ¯é˜Ÿåˆ—
```



#### æ¶ˆæ¯é˜Ÿåˆ—-kafka

##### æ¶ˆæ¯æ¨¡å¼

###### ç‚¹å¯¹ç‚¹æ¨¡å¼

```mermaid
flowchart LR
subgraph A[Producer]
end
subgraph B[Message Queue]
1
B6["4.åˆ é™¤å·²å¤„ç†æ¶ˆæ¯"]
2
3
4
5
end
subgraph C[Consumer]
C1[1]
end

A --"1.å‘é€æ¶ˆæ¯"--> B
C --"2.æ¥å—æ¶ˆæ¯"--> B
C1 --"3.ç¡®è®¤æ”¶åˆ°"--> B

style B6 fill:#f9f,stroke:#333,stroke-width:4px
```



###### å‘å¸ƒè®¢é˜…æ¨¡å¼

```mermaid
flowchart LR
subgraph A[Producer]
end
subgraph B[Message Queue]
    subgraph B1["Topic(ä¸»é¢˜)\nnews"]
    5
    4
    3
    2
    1
    end
    subgraph B2["Topic(ä¸»é¢˜)\ntech"]
    e
    d
    c
    b
    a
    end
end

subgraph C[Consumer]
	subgraph C1[Consumer-1]
	1
	end
	subgraph C2[Consumer-2]
	1
	end
	subgraph C3[Consumer-3]
	a
	end
end

A --å‘å¸ƒæ¶ˆæ¯--> B1
A --å‘å¸ƒæ¶ˆæ¯--> B2

B1 --è®¢é˜…ä¸»é¢˜--> C1
B1 --è®¢é˜…ä¸»é¢˜--> C2

B2 --è®¢é˜…ä¸»é¢˜--> C3
```

##### åŸç†

**åˆ†åŒºï¼ˆbrokerï¼‰**ï¼šæµ·é‡æ•°æ®åˆ†æ•£å­˜å‚¨

**å‰¯æœ¬**ï¼šæ¯ä¸ªæ•°æ®åŒºéƒ½æœ‰å¤‡ä»½

> åŒä¸€ä¸ªæ¶ˆè´¹ç»„é‡Œé¢çš„æ¶ˆè´¹è€…æ˜¯é˜Ÿåˆ—ç«äº‰æ¨¡å¼
>
> ä¸åŒæ¶ˆè´¹è€…ç»„é‡Œé¢çš„æ¶ˆè´¹è€…æ˜¯å‘å¸ƒ/è®¢é˜…æ¨¡å¼

```mermaid
flowchart LR
100T-newsæ•°æ®
subgraph A[Producer]
    A1[Producer]
    A2[Producer]
    A3[Producer]
end

subgraph B[Kafka Cluster]
	subgraph B1[Broker-0]
		B1-1["topic-news\npartition-0"]
		B1-2["topic-news\npartition-1"]
		B1-3["topic-news\npartition-2"]
	end
	subgraph B2[Broker-1]
		B2-1["topic-news\npartition-1"]
		B2-2["topic-news\npartition-0"]
		B2-3["topic-news\npartition-2"]
	end
	subgraph B3[Broker-2]
		B3-1["topic-news\npartition-2"]
		B3-2["topic-news\npartition-0"]
		B3-3["topic-news\npartition-1"]
	end
end

C["Zookeeper\nè®°å½•kafkaé›†ç¾¤æ•°æ®"]

subgraph D[Consumer Group]
	subgraph D1[Consumer Group]
		D1-1[Consumer1]
		D1-2[Consumer2]
		D1-3[Consumer3]
	end
	subgraph D2[Consumer Group]
		D2-1[Consumer1]
		D2-2[Consumer2]
		D2-3[Consumer3]
	end
	D3[Consumer]
end

A1 --push--> B1-1
A2 --push--> B2-1
A3 --push--> B3-1

B --> C

D1 --pull--> B
D2 --pull--> B
D3 --pull--> B

B1-1:::leader
B2-1:::leader
B3-1:::leader

B1-2:::follower
B2-2:::follower
B3-2:::follower

B1-3:::follower
B2-3:::follower
B3-3:::follower

classDef leader fill:#f96
classDef follower fill:#f99
```

##### spring-bootæ•´åˆ

[åœ°å€](https://www.bilibili.com/video/BV1Es4y1q7Bf/?p=77&spm_id_from=pageDriver&vd_source=5130b9290d02c548b42330a7df26470d)

 
